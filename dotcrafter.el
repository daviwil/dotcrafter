(defcustom dotcrafter-dotfiles-folder "~/.dotfiles"
  "The folder where dotfiles and org-mode configuration files are stored."
  :type 'string
  :group 'dotfiles)

(defcustom dotcrafter-output-directory "~"
  "The directory where dotcrafter.el will write out your dotfiles.
This is typically set to '~' but can be changed for testing
purposes."
  :type 'string
  :group 'dotfiles)

(defcustom dotcrafter-org-files '()
  "The list of org-mode files under the `dotcrafter-dotfiles-folder'
which contain configuration files that should be tangled"
  :type '(list string)
  :group 'dotfiles)

(defcustom dotcrafter-extra-files-directory ".files"
  "The directory path inside of `dotcrafter-dotfiles-folder' where
\"extra\" configuration files are stored."
  :type 'string
  :group 'dotfiles)

(defvar dotcrafter-gitignore-marker "\n# -- Generated by dotcrafter.el! --\n\n"
  "The marker string to be placed in the .gitignore file of the
dotfiles repo to indicate where the auto-generated list of ignored
files begins.")

(defun dotcrafter--scan-for-output-files (org-file)
  (let ((output-files '())
        (current-match t))
    ;; Get a buffer for the file, either one that is
    ;; already open or open a new one
    (with-current-buffer (or (get-file-buffer org-file)
                             (find-file-noselect org-file))
      ;; Save the current buffer position
      (save-excursion
        ;; Go back to the beginning of the buffer
        (goto-char (point-min))

        ;; Loop until no more matches are found
        (while current-match
          ;; Search for blocks with a :tangle property
          (setq current-match (search-forward ":tangle " nil t))
          (when current-match
            (let ((output-file (thing-at-point 'filename t)))
              ;; If a file path was found, add it to the list
              (unless (or (not output-file)
                          (string-equal output-file "no"))
                (setq output-files (cons output-file
                                         output-files))))))))
    output-files))

(defun dotcrafter--update-gitignore ()
  (let ((output-files '()))
    ;; Gather the list of output files from all Org files
    (dolist (org-file dotcrafter-org-files)
      (setq output-files
            (append output-files
                    (dotcrafter--scan-for-output-files
                     (expand-file-name org-file dotcrafter-dotfiles-folder)))))

    ;; Now that we have the output files, update the .gitignore file
    (let ((gitignore-file (expand-file-name ".gitignore"
                                            dotcrafter-dotfiles-folder)))
      ;; Find the .gitignore buffer and prepare for editing
      (with-current-buffer (or (get-file-buffer gitignore-file)
                               (find-file-noselect gitignore-file))
        (save-excursion
          ;; Find or insert the dotcrafter-gitignore-marker
          (beginning-of-buffer)
          (or (progn
                (search-forward dotcrafter-gitignore-marker nil t))
              (progn
                (end-of-buffer)
                (insert "\n" dotcrafter-gitignore-marker)))

          ;; Delete the rest of the buffer after the marker
          (delete-region (point) (point-max))

          ;; Insert a line for each output file
          (dolist (output-file output-files)
            (insert output-file "\n"))

          ;; Make sure the buffer is saved
          (save-buffer))))))

(defun dotcrafter-tangle-org-file (&optional org-file)
  "Tangles a single .org file relative to the path in
dotfiles-folder.  If no file is specified, tangle the current
file if it is an org-mode buffer inside of dotfiles-folder."
  (interactive)
  ;; Suppress prompts and messages
  (let ((org-confirm-babel-evaluate nil)
        (message-log-max nil)
        (inhibit-message t))
    (org-babel-tangle-file (expand-file-name org-file dotcrafter-dotfiles-folder))))

(defun dotcrafter-tangle-org-files ()
  "Tangles all of the .org files in the paths specified by the variable dotfiles-folder"
  (interactive)
  (dolist (org-file dotcrafter-org-files)
    (dotcrafter-tangle-org-file org-file))
  (message "Dotfiles are up to date!"))

(defun dotcrafter--link-extra-file-recur (current-path path-parts)
  (when path-parts
    ;; Create the current path using the first part and remove it from the
    ;; front of the list for future recursive calls
    (setq current-path (if current-path
                           (concat current-path "/" (car path-parts))
                         (car path-parts)))
    (setq path-parts (cdr path-parts))

    ;; Figure out whether the source can be linked to the target path
    (let ((source-path (expand-file-name (concat dotcrafter-extra-files-directory "/" current-path)
                                         dotcrafter-dotfiles-folder))
          (target-path (expand-file-name current-path dotcrafter-output-directory)))
      ;; If the file or directory exists, is it a symbolic link?
      (if (file-symlink-p target-path)
          ;; If the symbolic link exists, does it point to the source-path?
          (when (not (string-equal source-path (file-truename target-path)))
            (error "Path already exists with different symlink! %s" target-path))
        ;; Otherwise, the file is probably a directory so recurse
        (if (file-directory-p target-path)
            (dotcrafter--link-extra-file-recur current-path path-parts)
          ;; Create a symbolic link to the source-path!
          (make-symbolic-link source-path target-path))))))

(defun dotcrafter--link-extra-file (extra-file)
  (dotcrafter--link-extra-file-recur
   nil
   (split-string (file-relative-name (expand-file-name extra-file)
                                     (expand-file-name dotcrafter-extra-files-directory
                                                       dotcrafter-dotfiles-folder))
                 "/" t)))

(defun dotcrafter-link-extra-files ()
  (interactive)
  (let ((extra-files
         (directory-files-recursively
          (expand-file-name dotcrafter-extra-files-directory
                            dotcrafter-dotfiles-folder)
          "")))
    (dolist (file extra-files)
      (dotcrafter--link-extra-file file))))

(provide 'dotcrafter)
